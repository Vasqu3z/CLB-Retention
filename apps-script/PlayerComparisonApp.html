<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #1a73e8;
      margin-top: 0;
      text-align: center;
    }
    
    .player-selector {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .player-selector label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .player-selector select {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .button-group {
      margin: 20px 0;
      text-align: center;
    }
    
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
    }
    
    button:hover {
      background-color: #1557b0;
    }
    
    button.secondary {
      background-color: #5f6368;
    }
    
    button.secondary:hover {
      background-color: #484a4d;
    }
    
    .results {
      margin-top: 30px;
    }
    
    .stat-section {
      margin: 25px 0;
      border-top: 3px solid #1a73e8;
      padding-top: 15px;
    }
    
    .stat-section h3 {
      color: #1a73e8;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    
    th, td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    font-size: 13px;
    width: auto;
    min-width: 80px;  /* Ensures minimum width for data columns */
    max-width: 120px; /* Prevents columns from getting too wide */
    }

    .stat-label {
    font-weight: bold;
    width: 180px;      /* Fixed width for label column */
    min-width: 180px;
    max-width: 180px;
    text-align: left;
    padding-left: 15px;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .stat-label {
      font-weight: bold;
      width: 150px;
      text-align: left;
      padding-left: 15px;
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    
    .error {
      color: #d93025;
      padding: 10px;
      background: #fce8e6;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .player-header {
      text-align: center;
      font-weight: bold;
      background: #e8f0fe;
      padding: 10px;
      font-size: 13px;
    }
    
    .team-info {
      font-size: 11px;
      color: #5f6368;
      display: block;
      margin-top: 2px;
    }
    
    .category-overall {
      background-color: #e8f0fe;
      font-weight: bold;
      border-top: 2px solid #1a73e8;
    }
    
    .best-value {
      background-color: #d4edda;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öæÔ∏è Player Comparison Tool</h2>
    
    <div class="player-selector">
      <label for="player1">Player 1:</label>
      <select id="player1">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player2">Player 2:</label>
      <select id="player2">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player3">Player 3 (Optional):</label>
      <select id="player3">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player4">Player 4 (Optional):</label>
      <select id="player4">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player5">Player 5 (Optional):</label>
      <select id="player5">
        <option value="">-- Select Player --</option>
      </select>
    </div>
    
    <div class="button-group">
      <button onclick="comparePlayers()">üìä Compare Players</button>
      <button class="secondary" onclick="clearSelection()">üîÑ Clear</button>
    </div>
    
    <div id="results" class="results"></div>
  </div>

  <script>
    window.onload = function() {
      google.script.run
        .withSuccessHandler(populatePlayerDropdowns)
        .withFailureHandler(showError)
        .getPlayerList();
    };
    
    function populatePlayerDropdowns(players) {
      var selects = ['player1', 'player2', 'player3', 'player4', 'player5'];
      
      selects.forEach(function(selectId) {
        var select = document.getElementById(selectId);
        
        players.forEach(function(player) {
          var option = document.createElement('option');
          option.value = player.name;
          option.textContent = player.name + ' (' + player.team + ')';
          select.appendChild(option);
        });
      });
    }
    
    function comparePlayers() {
      var player1 = document.getElementById('player1').value;
      var player2 = document.getElementById('player2').value;
      var player3 = document.getElementById('player3').value;
      var player4 = document.getElementById('player4').value;
      var player5 = document.getElementById('player5').value;
      
      if (!player1 || !player2) {
        showError('Please select at least 2 players to compare.');
        return;
      }
      
      var playerNames = [player1, player2];
      if (player3) playerNames.push(player3);
      if (player4) playerNames.push(player4);
      if (player5) playerNames.push(player5);
      
      document.getElementById('results').innerHTML = '<div class="loading">Loading stats...</div>';
      
      google.script.run
        .withSuccessHandler(displayResults)
        .withFailureHandler(showError)
        .getPlayerStats(playerNames);
    }
    
    function displayResults(stats) {
      var html = '';
      
      // Hitting Stats
      html += '<div class="stat-section">';
      html += '<h3>üèè Hitting Stats</h3>';
      html += '<table><thead><tr><th class="stat-label">Stat</th>';
      
      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name;
        if (player.hitting.team) {
          html += '<span class="team-info">(' + player.hitting.team + ')</span>';
        }
        html += '</th>';
      });
      
      html += '</tr></thead><tbody>';
      
      // Add Batting Average as category overall
      html += '<tr class="category-overall"><td class="stat-label">Batting Average</td>';
      var avgValues = stats.map(function(p) { return p.hitting.avg || 0; });
      var maxAvg = Math.max.apply(null, avgValues);
      
      stats.forEach(function(player) {
        var value = player.hitting.avg;
        var cellClass = (value === maxAvg && maxAvg > 0) ? ' class="best-value"' : '';
        html += '<td' + cellClass + '>' + formatAverage(value) + '</td>';
      });
      html += '</tr>';
      
      var hittingStats = [
        {label: 'Games Played', key: 'gp', higher: true},
        {label: 'At Bats', key: 'ab', higher: true},
        {label: 'Hits', key: 'h', higher: true},
        {label: 'Home Runs', key: 'hr', higher: true},
        {label: 'RBI', key: 'rbi', higher: true},
        {label: 'Walks', key: 'bb', higher: true},
        {label: 'Strikeouts', key: 'k', higher: false},
        {label: 'Total Bases', key: 'tb', higher: true},
        {label: 'On-Base %', key: 'obp', higher: true, format: 'avg'},
        {label: 'Slugging %', key: 'slg', higher: true, format: 'avg'},
        {label: 'OPS', key: 'ops', higher: true, format: 'avg'}
      ];
      
      hittingStats.forEach(function(stat) {
        html += '<tr><td class="stat-label">' + stat.label + '</td>';
        
        var values = stats.map(function(p) { 
          var val = p.hitting[stat.key];
          return (val !== undefined && val !== null && val !== '') ? val : 0;
        });
        
        var bestValue = stat.higher ? Math.max.apply(null, values) : Math.min.apply(null, values.filter(function(v) { return v > 0; }));
        
        stats.forEach(function(player) {
          var value = player.hitting[stat.key];
          var cellClass = '';
          
          if (value !== undefined && value !== null && value !== '') {
            if (stat.higher && value === bestValue && bestValue > 0) {
              cellClass = ' class="best-value"';
            } else if (!stat.higher && value === bestValue && bestValue > 0) {
              cellClass = ' class="best-value"';
            }
            
            if (stat.format === 'avg') {
              value = formatAverage(value);
            }
            html += '<td' + cellClass + '>' + value + '</td>';
          } else {
            html += '<td>-</td>';
          }
        });
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      // Pitching Stats
      html += '<div class="stat-section">';
      html += '<h3>‚öæ Pitching Stats</h3>';
      html += '<table><thead><tr><th class="stat-label">Stat</th>';
      
      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });
      
      html += '</tr></thead><tbody>';
      
      // Add ERA as category overall
      html += '<tr class="category-overall"><td class="stat-label">ERA</td>';
      var eraValues = stats.map(function(p) { 
        var val = p.pitching.era;
        return (val !== undefined && val !== null && val !== '' && val > 0) ? val : 999;
      });
      var minEra = Math.min.apply(null, eraValues);
      if (minEra === 999) minEra = null;
      
      stats.forEach(function(player) {
        var value = player.pitching.era;
        var cellClass = '';
        if (value !== undefined && value !== null && value !== '' && value === minEra && minEra !== null) {
          cellClass = ' class="best-value"';
        }
        var displayValue = (value !== undefined && value !== null && value !== '') ? 
          (typeof value === 'number' ? value.toFixed(2) : value) : '-';
        html += '<td' + cellClass + '>' + displayValue + '</td>';
      });
      html += '</tr>';
      
      var pitchingStats = [
        {label: 'Games Played', key: 'gp', higher: true},
        {label: 'Wins', key: 'w', higher: true},
        {label: 'Losses', key: 'l', higher: false},
        {label: 'Saves', key: 'sv', higher: true},
        {label: 'Innings Pitched', key: 'ip', higher: true, format: 'decimal'},
        {label: 'Batters Faced', key: 'bf', higher: true},
        {label: 'Hits Allowed', key: 'h', higher: false},
        {label: 'Home Runs Allowed', key: 'hr', higher: false},
        {label: 'Runs Allowed', key: 'r', higher: false},
        {label: 'Walks', key: 'bb', higher: false},
        {label: 'Strikeouts', key: 'k', higher: true},
        {label: 'BAA', key: 'baa', higher: false, format: 'avg'},
        {label: 'WHIP', key: 'whip', higher: false, format: 'decimal'}
      ];
      
      pitchingStats.forEach(function(stat) {
        html += '<tr><td class="stat-label">' + stat.label + '</td>';
        
        var values = stats.map(function(p) { 
          var val = p.pitching[stat.key];
          if (val === undefined || val === null || val === '') return null;
          return val;
        }).filter(function(v) { return v !== null; });
        
        var bestValue = null;
        if (values.length > 0) {
          if (stat.higher) {
            bestValue = Math.max.apply(null, values);
          } else {
            bestValue = Math.min.apply(null, values.filter(function(v) { return v > 0; }));
          }
        }
        
        stats.forEach(function(player) {
          var value = player.pitching[stat.key];
          var cellClass = '';
          
          if (value !== undefined && value !== null && value !== '') {
            if (value === bestValue && bestValue !== null) {
              cellClass = ' class="best-value"';
            }
            
            if (stat.format === 'avg') {
              value = formatAverage(value);
            } else if (stat.format === 'decimal') {
              value = typeof value === 'number' ? value.toFixed(2) : value;
            }
            html += '<td' + cellClass + '>' + value + '</td>';
          } else {
            html += '<td>-</td>';
          }
        });
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      // Fielding & Baserunning Stats
      html += '<div class="stat-section">';
      html += '<h3>üß§ Fielding & Baserunning Stats</h3>';
      html += '<table><thead><tr><th class="stat-label">Stat</th>';
      
      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });
      
      html += '</tr></thead><tbody>';
      
      var fieldingStats = [
        {label: 'Games Played', key: 'gp', higher: true},
        {label: 'Nice Plays', key: 'np', higher: true},
        {label: 'Errors', key: 'e', higher: false},
        {label: 'Stolen Bases', key: 'sb', higher: true}
      ];
      
      fieldingStats.forEach(function(stat) {
        html += '<tr><td class="stat-label">' + stat.label + '</td>';
        
        var values = stats.map(function(p) { 
          var val = p.fielding[stat.key];
          if (val === undefined || val === null || val === '') return null;
          return val;
        }).filter(function(v) { return v !== null; });
        
        var bestValue = null;
        if (values.length > 0) {
          if (stat.higher) {
            bestValue = Math.max.apply(null, values);
          } else {
            // For errors (lower is better), only highlight if there are actual errors
            var positiveValues = values.filter(function(v) { return v > 0; });
            if (positiveValues.length > 0) {
              bestValue = Math.min.apply(null, positiveValues);
            }
          }
        }
        
        stats.forEach(function(player) {
          var value = player.fielding[stat.key];
          var cellClass = '';
          
          if (value !== undefined && value !== null && value !== '') {
            if (value === bestValue && bestValue !== null) {
              cellClass = ' class="best-value"';
            }
            html += '<td' + cellClass + '>' + value + '</td>';
          } else {
            html += '<td>-</td>';
          }
        });
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      document.getElementById('results').innerHTML = html;
    }
    
    function formatAverage(value) {
      if (value === undefined || value === null || value === '') return '-';
      if (typeof value !== 'number') return value;
      if (value >= 1) {
        return value.toFixed(3); // Keep full number for 1.000+
      }
      return value.toFixed(3).substring(1); // Remove leading 0 for .xxx
    }
    
    function clearSelection() {
      document.getElementById('player1').value = '';
      document.getElementById('player2').value = '';
      document.getElementById('player3').value = '';
      document.getElementById('player4').value = '';
      document.getElementById('player5').value = '';
      document.getElementById('results').innerHTML = '';
    }
    
    function showError(error) {
      document.getElementById('results').innerHTML = 
        '<div class="error">‚ö†Ô∏è Error: ' + error + '</div>';
    }
  </script>
</body>
</html>
